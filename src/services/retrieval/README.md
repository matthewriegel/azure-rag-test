# Retrieval Service

Hybrid search service combining vector similarity and BM25 lexical scoring to retrieve relevant document chunks from Azure AI Search.

## Architecture

```mermaid
graph TB
    A[Query Text] --> B[Generate Embedding]
    B --> C[OpenAI Embeddings API]
    C --> D[Query Vector]
    D --> E[Hybrid Search]
    F[Customer Filter] --> E
    E --> G[Azure AI Search]
    G --> H[Top-K Results]
    H --> I[Calculate Avg Scores]
    I --> J[Return RetrievalResult]
```

## Retrieval Flow

```mermaid
sequenceDiagram
    participant S as Service
    participant R as Retrieval
    participant O as OpenAI
    participant A as AI Search

    S->>R: retrieveDocuments(query, customerId)
    R->>O: getEmbeddings(query)
    O-->>R: query vector
    R->>A: hybridSearch(vector, filter, topK)
    A-->>R: ranked results
    R->>R: Calculate avgSimilarity (top-3)
    R->>R: Calculate avgLexical (all)
    R-->>S: {results, avgSimilarityScore, avgLexicalScore}
```

## Hybrid Search

Combines two scoring mechanisms:
- **Vector similarity**: Cosine similarity in 3072-dim space
- **BM25 lexical**: Keyword-based relevance

Results are merged and ranked by Azure AI Search.

## File Pointers

- **Service**: `src/services/retrieval/retrievalService.ts`
- **Uses**: `lib/azure/searchClient.ts`, `lib/azure/openaiClient.ts`

## Example Usage

```typescript
import { retrieveDocuments } from './services/retrieval';

const result = await retrieveDocuments({
  query: 'customer email address',
  customerId: 'cust-123',
  topK: 5
});

console.log(`Found ${result.results.length} results`);
console.log(`Avg similarity: ${result.avgSimilarityScore}`);
```

---

**Last updated**: 2026-02-01T15:43:00Z  
**Author**: Generated by Copilot action prompt; review recommended
